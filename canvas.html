<!doctype html>

<style>
body {
  background: lightblue;
  margin: 0;
}
</style>

<script type="module">
import { AppCanvas } from './src/app_canvas.mjs';
import { DataSource } from './src/data_source.mjs';
import { Theme } from './src/theme.mjs';
import { Layout } from './src/layout.mjs';
import { RunLoop } from './src/run_loop.mjs';
import { Rasterizer } from './src/rasterizer.mjs';
import { DragControl } from './src/drag_control.mjs';
import { UserItem } from './src/data_sources/special_items.mjs';

let app_canvas;
let rasterizer;
let layout;
let drag_control;

RunLoop.draw = () => {
  layout.layoutIfNeeded();
  rasterizer.draw(layout.tree);
}

async function initialize() {
  app_canvas = new AppCanvas();
  app_canvas.addEventListener("mousedown", handleMouseDown);
  app_canvas.addEventListener("mousemove", handleMouseMove);
  app_canvas.addEventListener("mousemove", handleHoverPointer);
  app_canvas.addEventListener("mouseup", handleMouseUp);
  app_canvas.addEventListener("click", handleClick);
  app_canvas.addEventListener("dblclick", handleDoubleClick);
  window.addEventListener("keyup", handleKeyUp);

  rasterizer = new Rasterizer(app_canvas);
  layout = new Layout(app_canvas.ctx);
  drag_control = new DragControl(layout);

  const data_source = DataSource.Create("github");
  await data_source.load();
  let y = 0;
  for (let i = 0; i < data_source.data.length; ++i) {
    const item = layout.addItem(data_source.data[i], [0, y]);
    const bounding_box = item.bounding_box;
    item.position = [-bounding_box.left, y];
    y += bounding_box.height + 2;
  }
  layout.layout();
}

function handleMouseDown(p) {
  app_canvas.finishEdit();
  return drag_control.handleMouseDown(p);
}

function handleMouseUp() {
  return drag_control.handleMouseUp();
}

function handleMouseMove(p, delta) {
  return drag_control.handleMouseMove(p, delta);
}

function handleHoverPointer(p) {
  if (app_canvas.dragging)
    return;
  const decorator = layout.getDecoratorAtPoint(p);
  if (decorator && decorator.handleClick) {
    app_canvas.canvas.style.cursor = "pointer";
  } else {
    app_canvas.canvas.style.cursor = "default";
  }
}

function handleClick(p) {
  const decorator = layout.getDecoratorAtPoint(p);
  decorator && decorator.handleClick && decorator.handleClick();
}

function handleDoubleClick(p) {
  
  const item = layout.getItemAtPoint(p);
  let editing_item;
  if (item) {
    editing_item = item;
  } else {
    editing_item = layout.addItem(
      new UserItem(),
      [p[0] - Theme.padding(), p[1] - Theme.padding()]);
  }
  app_canvas.startEdit(editing_item);
  return true;
}

function handleKeyUp(e) {
}

onload = () => {
  requestAnimationFrame(() => {
    initialize().then(() => RunLoop.postTaskAndDraw());
  });
}

</script>
